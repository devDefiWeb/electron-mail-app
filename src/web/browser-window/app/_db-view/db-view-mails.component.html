<div
    *ngIf="(items$ | async) as items"
    class="controls d-flex align-items-center flex-shrink-0 mb-2"
>
    <div class="d-flex flex-grow-1">
        <button
            (click)="makeAllRead()"
            *ngrxLet="unreadCount$ as count"
            [disabled]="(makeAllReadButtonLocked$ | async) || false"
            class="btn btn-sm btn-primary text-nowrap mr-2"
        >
            Make all read
            <ng-container [ngSwitch]="makeAllReadInProgress$ | async">
                <i *ngSwitchCase="true" class="fa fa-spinner fa-pulse fa-fw ml-1"></i>
                <span *ngSwitchDefault [innerText]="count ? '(' + count + ')' : ''" class="ml-1"></span>
            </ng-container>
        </button>
        <div
            #moveAllToDropdown="bs-dropdown"
            *ngrxLet="plainItemsCount$ as count"
            [isDisabled]="(setFolderButtonLocked$ | async) || false"
            class="btn-group"
            dropdown
        >
            <button
                class="btn btn-sm btn-primary dropdown-toggle mr-2"
                dropdownToggle
                type="button"
            >
                Move all to
                <ng-container [ngSwitch]="setFolderInProgress$ | async">
                    <i *ngSwitchCase="true" class="fa fa-spinner fa-pulse fa-fw ml-1"></i>
                    <span *ngSwitchDefault [innerText]="count ? '(' + count + ')' : ''" class="ml-1"></span>
                </ng-container>
                <span class="caret"></span>
                <ul *dropdownMenu class="dropdown-menu px-0 py-1" role="menu">
                    <li
                        (click)="moveAllToDropdown.hide(); setFolder(folder.id)"
                        *ngFor="let folder of (moveToFolders$ | async)"
                        role="menuitem"
                    >
                        <a class="dropdown-item px-2" href="#">
                            <electron-mail-db-view-folder [folder]="folder"></electron-mail-db-view-folder>
                        </a>
                    </li>
                </ul>
            </button>
        </div>
        <ng-content select="[controls]"></ng-content>
        <div class="btn btn-sm border border-secondary-light" style="cursor: default;">
            {{ title$ | async }}<span *ngIf="items.length">: {{ (paging$ | async)?.end }} of {{ items.length }}</span>
        </div>
    </div>
    <div class="d-flex">
        <div
            *ngrxLet="plainItemsCount$ as count"
            [isDisabled]="(deletingMessagesButtonLocked$ | async) || false"
            class="btn-group mx-2"
            dropdown
            placement="bottom right"
        >
            <button
                class="btn btn-sm btn-outline-danger dropdown-toggle"
                dropdownToggle
                type="button"
            >
                <i class="fa fa-times mr-1"></i>
                Delete
                <ng-container [ngSwitch]="deletingMessagesInProgress$ | async">
                    <i *ngSwitchCase="true" class="fa fa-spinner fa-pulse fa-fw ml-1"></i>
                    <span *ngSwitchDefault [innerText]="count ? '(' + count + ')' : ''" class="ml-1"></span>
                </ng-container>
                <span class="caret"></span>
            </button>
            <ul *dropdownMenu class="dropdown-menu dropdown-menu-right px-0 py-1" role="menu">
                <li>
                    <a
                        (click)="deleteMessages()"
                        class="dropdown-item px-2"
                        href="#"
                        role="menuitem"
                    >
                        <i class="fa fa-times text-danger"></i>
                        Confirm <span class="text-danger">permanent</span> deleting
                    </a>
                </li>
            </ul>
        </div>
        <electron-mail-db-view-mails-export
            [dbAccountPk]="dbAccountPk"
            [mailsBundleItems]="items"
            [title]="'Export' + (items.length ? ' (' + items.length + ')' : '')"
        ></electron-mail-db-view-mails-export>
        <select
            #sortSelect
            (change)="sortChange(sortSelect.value)"
            *ngIf="sorting$ | async; let sorting;"
            class="form-control form-control-sm ml-2 align-self-stretch"
        >
            <option
                *ngFor="let sorter of sorting.sorters; index as i;"
                [selected]="i == sorting.sorterIndex"
                [value]="i"
            >
                Sort by: {{ sorter.title }}
            </option>
        </select>
    </div>
</div>
<div
    *ngIf="items$ | async; let items;"
    class="overflow-auto"
>
    <!-- TODO consider using "virtual list", ie render only visible data -->
    <electron-mail-db-view-mail
        *ngFor="let item of items.slice(0, (paging$ | async)?.end); trackBy: trackByMailBundleItem"
        [attr.data-pk]="item.mail.pk"
        [conversationSize]="item.conversationSize"
        [mail]="item.mail"
    ></electron-mail-db-view-mail>
    <button
        (click)="loadMore()"
        *ngIf="(paging$ | async)?.nextPageSize; let nextPageSize;"
        class="btn btn-sm btn-secondary-light load-more my-3"
    >
        More
        <small>(+{{ nextPageSize }})</small>
    </button>
</div>
