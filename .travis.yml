# https://docs.travis-ci.com/user/customizing-the-build/

branches:
  only:
    - master
language: node_js
node_js: 10
cache:
  directories:
    - $HOME/.cache/yarn
    - ./output/git
env:
  global:
    - CI=true
    - NO_AT_BRIDGE=1
    - MOZ_HEADLESS=1
    - ELECTRON_CACHE=$HOME/.cache/electron
    - ELECTRON_BUILDER_CACHE=$HOME/.cache/electron-builder
    - EMAIL_SECURELY_APP_GITHUB_ARTIFACT_NAME=travis-${TRAVIS_BUILD_NUMBER}-id-${TRAVIS_BUILD_ID}-commit-${TRAVIS_COMMIT}.zip
addons:
  firefox: latest
jobs:
  include:
    - stage: prepare web clients artifact
      os: linux
      addons:
        apt:
          packages:
            - libsecret-1-dev
            - nasm
      script:
        - yarn run assets:tutanota-webclient
        - yarn run assets:protonmail-webclient
        - zip -r $EMAIL_SECURELY_APP_GITHUB_ARTIFACT_NAME ./app
        - ls
        - yarn run ci:travis:upload-artifact
    - stage: build app
      os: osx
      osx_image: xcode9.4
      script: ./scripts/travis-build-app.sh
    - stage: build app
      os: linux
      dist: trusty
      group: stable
      sudo: required
      services:
        - docker
      addons:
        apt:
          packages:
            - gnome-keyring
            - libgnome-keyring-dev
            - libsecret-1-dev
            - python-gnomekeyring
      before_script:
        - |
          export DISPLAY=:99.0; sh -e /etc/init.d/xvfb start; sleep 3;
          eval $(dbus-launch --sh-syntax);
          eval $(echo -n "" | /usr/bin/gnome-keyring-daemon --login);
          eval $(/usr/bin/gnome-keyring-daemon --components=secrets --start);
          /usr/bin/python -c "import gnomekeyring;gnomekeyring.create_sync('login', '');";
      script: ./scripts/travis-build-app.sh
install:
  - yarn --pure-lockfile install
  - yarn generate-npm-lockfile
  - npm audit
notifications:
  email:
    on_success: never
    on_failure: change
